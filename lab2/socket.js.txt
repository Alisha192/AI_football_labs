// socket.js - Ð£Ð»ÑƒÑ‡ÑˆÐµÐ½Ð½Ñ‹Ð¹ ÑÐ¾ÐºÐµÑ‚ Ñ Ð»Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸ÐµÐ¼
const dgram = require('dgram');

module.exports = function(agent, teamName, version) {
    console.log(`ðŸ”Œ Creating UDP socket for ${teamName}...`);

    const socket = dgram.createSocket({ type: 'udp4', reuseAddr: true });

    socket.on('message', (msg, info) => {
        const messageStr = msg.toString();
        console.log(`ðŸ“¨ Received ${messageStr.length} bytes from ${info.address}:${info.port}`);

        try {
            agent.handleMessage(messageStr);
        } catch (e) {
            console.error('âŒ Error handling message:', e);
            console.error('Message:', messageStr);
        }
    });

    socket.on('error', (err) => {
        console.error('âŒ Socket error:', err);
    });

    socket.on('listening', () => {
        const address = socket.address();
        console.log(`âœ… Socket listening on ${address.address}:${address.port}`);
    });

    socket.sendMsg = function(msg) {
        console.log(`ðŸ“¤ Sending ${msg.length} bytes: ${msg.substring(0, 100)}${msg.length > 100 ? '...' : ''}`);

        socket.send(Buffer.from(msg), 6000, 'localhost', (err, bytes) => {
            if (err) {
                console.error('âŒ Send error:', err);
            } else {
                console.log(`âœ… Sent ${bytes} bytes`);
            }
        });
    };

    // ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ÑÑ Ðº ÑÐµÑ€Ð²ÐµÑ€Ñƒ
    const initMsg = `(init ${teamName} (version ${version}))`;
    console.log(`ðŸ”Œ Connecting with: ${initMsg}`);

    setTimeout(() => {
        socket.sendMsg(initMsg);
    }, 500);

    agent.setSocket(socket);

    console.log("âœ… Socket module initialized");

    return socket;
};