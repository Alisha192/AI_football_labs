// agent.js - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –¥—Ä–∏–±–ª–∏–Ω–≥–æ–º
const Msg = require('./msg');
const Localization = require('./localization');
const Navigation = require('./navigation');
const Flags = require('./flags');

class Agent {
    constructor() {
        this.position = "l";
        this.run = false;
        this.socket = null;
        this.playerNumber = null;
        this.initialized = false;

        this.nav = new Navigation();

        // –ú–∞—Ä—à—Ä—É—Ç –∏–∑ –º–µ—Ç–æ–¥–∏—á–∫–∏:
        // 1. –î–æ–π—Ç–∏ –¥–æ –ø—Ä–∞–≤–æ–≥–æ –Ω–∏–∂–Ω–µ–≥–æ —É–≥–ª–∞ (f r b)
        // 2. –î–æ–π—Ç–∏ –¥–æ –ª–µ–≤—ã—Ö –≤–æ—Ä–æ—Ç (g l)
        // 3. –î–æ–π—Ç–∏ –¥–æ —Ü–µ–Ω—Ç—Ä–∞ (f c)
        // 4. –í–ï–°–¢–ò –º—è—á –∫ –≤–æ—Ä–æ—Ç–∞–º –∏ –£–î–ê–†–ò–¢–¨
        this.route = [
            { act: "flag", name: "f r b" },   // 0: –ø—Ä–∞–≤—ã–π –Ω–∏–∂–Ω–∏–π —É–≥–æ–ª
            { act: "flag", name: "g l" },      // 1: –ª–µ–≤—ã–µ –≤–æ—Ä–æ—Ç–∞
            { act: "flag", name: "f c" },       // 2: —Ü–µ–Ω—Ç—Ä
            { act: "dribble", name: "b", goal: "g r" }  // 3: –≤–µ–¥–µ–Ω–∏–µ + —É–¥–∞—Ä
        ];

        this.currentRouteIndex = 0;
        this.searchStep = 0;
        this.noTargetCounter = 0;

        this.currentPos = { x: 0, y: 0 };
        this.currentOrientation = 0;
        this.visibleObjects = [];

        // –°–æ—Å—Ç–æ—è–Ω–∏–µ –≤–µ–¥–µ–Ω–∏—è –º—è—á–∞
        this.dribbleState = {
            phase: "approach",        // approach, control, dribble, shoot
            lastBallDist: 999,
            ballUnderControl: false,
            kickTimer: 0,
            targetGoalPos: { x: 52.5, y: 0 }, // –ø—Ä–∞–≤—ã–µ –≤–æ—Ä–æ—Ç–∞ (gr)
            lastKickTime: 0,
            consecutiveKicks: 0
        };

        // –§–ª–∞–≥ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        this.lastAction = "";
        this.lastTime = 0;

        console.log("=====================================");
        console.log("ROUTE INITIALIZED:");
        this.route.forEach((point, i) => {
            console.log(`  ${i}: ${point.act} - ${point.name}${point.goal ? ' -> ' + point.goal : ''}`);
        });
        console.log("=====================================");
    }

    setSocket(socket) {
        this.socket = socket;
    }

    // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–º–∞–Ω–¥ —Å –ª—é–±—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
    socketSend(cmd, ...params) {
        const paramStr = params.join(' ');
        const fullCommand = `(${cmd} ${paramStr})`;
        // console.log(`Sending: ${fullCommand}`); // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏
        this.socket.sendMsg(fullCommand);
    }

    handleMessage(msg) {
        let data = Msg.parseMsg(msg);
        if (!data) return;

        if (data.cmd == "hear") {
            this.handleHear(data);
        } else if (data.cmd == "init") {
            this.handleInit(data);
        } else if (data.cmd == "see") {
            this.handleSee(data);
        }
    }

    handleHear(data) {
        if (data.p[1] == "referee" && data.p[2] == "play_on") {
            console.log("Game started!");
            this.run = true;
        }

        if (data.p[1] == "referee" && data.p[2] && data.p[2].startsWith("goal_")) {
            console.log(`üéâ GOAL! ${data.p[2]}`);
            this.currentRouteIndex = 0;
            this.searchStep = 0;
            this.dribbleState.phase = "approach";
            this.dribbleState.ballUnderControl = false;
        }
    }

    handleInit(data) {
        this.position = data.p[0];
        this.playerNumber = data.p[1];
        this.initialized = true;
        console.log(`Agent initialized: ${this.position}${this.playerNumber}`);
    }

    handleSee(data) {
        if (!this.run) return;

        const time = data.p[0];
        this.lastTime = time;
        this.visibleObjects = [];
        const visibleFlags = [];
        let ball = null;
        let goal = null;

        // –ü–∞—Ä—Å–∏–º –≤–∏–¥–∏–º—ã–µ –æ–±—ä–µ–∫—Ç—ã
        for (let i = 1; i < data.p.length; i++) {
            const obj = data.p[i];
            if (!obj.cmd || !obj.cmd.p) continue;

            let nameParts = [];
            for (let j = 0; j < obj.cmd.p.length; j++) {
                nameParts.push(obj.cmd.p[j]);
            }
            const name = nameParts.join(" ");

            if (obj.p && obj.p.length >= 2) {
                const distance = obj.p[0];
                const direction = obj.p[1];

                const object = {
                    name,
                    distance,
                    direction,
                    time: time
                };
                this.visibleObjects.push(object);

                if (name == "b") {
                    ball = object;
                }

                if (name == "g r") {
                    goal = object;
                }

                if (name.startsWith("f") && Flags[name]) {
                    visibleFlags.push(object);
                }
            }
        }

        // –í—ã—á–∏—Å–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é
        if (visibleFlags.length >= 2) {
            const solutions = Localization.triangulate(visibleFlags[0], visibleFlags[1]);

            if (solutions) {
                let pos;
                if (visibleFlags.length >= 3) {
                    pos = Localization.resolveWithThirdFlag(
                        solutions.sol1, solutions.sol2, visibleFlags[2]
                    );
                } else {
                    pos = solutions.sol1;
                }

                const orientation = Localization.computeOrientation(pos, visibleFlags[0]);

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏–∑–º–µ–Ω–∏–ª–∞—Å—å –ª–∏ –ø–æ–∑–∏—Ü–∏—è
                const moved = Math.abs(this.currentPos.x - pos.x) > 0.1 ||
                             Math.abs(this.currentPos.y - pos.y) > 0.1;

                this.currentPos = pos;
                this.currentOrientation = orientation;

                if (moved || time % 10 === 0) {
                    console.log(`Time ${time}: Pos=(${pos.x.toFixed(1)}, ${pos.y.toFixed(1)}), Ori=${orientation.toFixed(1)}`);
                }
            }
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º—è—á–∞
        if (ball) {
            this.dribbleState.lastBallDist = ball.distance;

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç –ª–∏ –∏–≥—Ä–æ–∫ –º—è—á
            // –î–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è –º—è—á –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—á–µ–Ω—å –±–ª–∏–∑–∫–æ
            if (ball.distance < 0.7) {
                if (!this.dribbleState.ballUnderControl) {
                    console.log(`‚öΩ BALL UNDER CONTROL! (dist=${ball.distance.toFixed(2)})`);
                    this.dribbleState.ballUnderControl = true;
                }
            } else {
                if (this.dribbleState.ballUnderControl) {
                    console.log(`‚ùå LOST BALL CONTROL (dist=${ball.distance.toFixed(2)})`);
                    this.dribbleState.ballUnderControl = false;
                }
            }
        } else {
            this.dribbleState.ballUnderControl = false;
        }

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤–æ—Ä–æ—Ç–∞—Ö, –µ—Å–ª–∏ –æ–Ω–∏ –≤–∏–¥–Ω—ã
        if (goal) {
            this.dribbleState.targetGoalPos = {
                x: 52.5,
                y: 0,
                angle: goal.direction,
                distance: goal.distance
            };
        }

        // –í—ã–ø–æ–ª–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ
        this.executeCurrentAction(time);
    }

    executeCurrentAction(time) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –≤—ã—à–ª–∏ –ª–∏ –∑–∞ –ø—Ä–µ–¥–µ–ª—ã –º–∞—Ä—à—Ä—É—Ç–∞
        if (this.currentRouteIndex >= this.route.length) {
            console.log("Route completed, restarting from beginning!");
            this.currentRouteIndex = 0;
        }

        const action = this.route[this.currentRouteIndex];

        // –û–¢–õ–ê–î–ö–ê
        console.log(`[${this.currentRouteIndex}/${this.route.length}] Action: ${action.act} - ${action.name}${action.goal ? ' -> ' + action.goal : ''}`);

        if (action.act === "flag") {
            // –î–≤–∏–∂–µ–Ω–∏–µ –∫ —Ñ–ª–∞–≥—É (–±–µ–∑ –º—è—á–∞)
            this.moveToFlag(action.name, time);
        } else if (action.act === "dribble") {
            // –í–µ–¥–µ–Ω–∏–µ –º—è—á–∞ –∫ –≤–æ—Ä–æ—Ç–∞–º
            this.dribbleToGoal(action.goal, time);
        }
    }

    moveToFlag(flagName, time) {
        const targetFlag = this.visibleObjects.find(obj => obj.name === flagName);

        if (!targetFlag) {
            this.noTargetCounter++;

            if (this.noTargetCounter > 10) {
                console.log(`üîç Searching for ${flagName}...`);
                this.lastAction = `search_${flagName}`;
                this.socketSend("turn", 90);
            } else {
                console.log(`Flag ${flagName} not visible, turning...`);
                this.lastAction = "turn_search";
                this.socketSend("turn", 45);
            }
            return;
        }

        // –°–±—Ä–æ—Å —Å—á–µ—Ç—á–∏–∫–∞ –ø–æ–∏—Å–∫–∞
        this.noTargetCounter = 0;

        const distance = targetFlag.distance;
        const direction = targetFlag.direction;

        console.log(`üéØ Target ${flagName}: dist=${distance.toFixed(1)}, dir=${direction.toFixed(1)}`);

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Ñ–ª–∞–≥–∞
        if (distance < 3.0) {
            console.log(`‚úÖ‚úÖ‚úÖ Flag ${flagName} REACHED! Moving to next target`);
            console.log(`   Previous index: ${this.currentRouteIndex} -> New index: ${this.currentRouteIndex + 1}`);

            this.currentRouteIndex++;
            this.searchStep = 0;
            this.lastAction = "reached";
            return;
        }

        // –î–≤–∏–∂–µ–Ω–∏–µ –∫ —Ñ–ª–∞–≥—É
        if (Math.abs(direction) > 5) {
            console.log(`‚Ü©Ô∏è Turning to ${flagName}...`);
            this.lastAction = "turn_to_flag";
            this.socketSend("turn", direction);
        } else {
            let dashPower = 100;
            if (distance < 10) {
                dashPower = 50 + distance * 5;
            }
            console.log(`üèÉ Running to ${flagName} with power ${Math.round(dashPower)}`);
            this.lastAction = "run_to_flag";
            this.socketSend("dash", Math.round(dashPower));
        }
    }

    dribbleToGoal(goalName, time) {
        const ball = this.visibleObjects.find(obj => obj.name === "b");

        if (!ball) {
            console.log("üîç Ball lost, searching...");
            this.lastAction = "search_ball";
            this.socketSend("turn", 45);
            return;
        }

        const goal = this.visibleObjects.find(obj => obj.name === goalName);

        console.log(`‚öΩ Ball: dist=${ball.distance.toFixed(2)}, dir=${ball.direction.toFixed(1)}`);

        // ===========================================
        // –ü–†–ê–í–ò–õ–¨–ù–û–ï –í–ï–î–ï–ù–ò–ï –ú–Ø–ß–ê (dribble)
        // –ò–≥—Ä–æ–∫ –¥–æ–ª–∂–µ–Ω –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å –º—è—á
        // ===========================================

        // –≠–¢–ê–ü 1: –ü–û–î–•–û–î –ö –ú–Ø–ß–£
        if (ball.distance > 1.0) {
            console.log("üèÉ APPROACHING ball...");
            this.lastAction = "approach_ball";
            this.dribbleState.phase = "approach";

            if (Math.abs(ball.direction) > 10) {
                // –ü–æ–≤–æ—Ä–∞—á–∏–≤–∞–µ–º—Å—è –∫ –º—è—á—É
                let turnPower = ball.direction * 0.8;
                this.socketSend("turn", turnPower);
            } else {
                // –ë–µ–∂–∏–º –∫ –º—è—á—É
                let dashPower = 60;
                if (ball.distance > 5) dashPower = 80;
                this.socketSend("dash", dashPower);
            }
            return;
        }

        // –≠–¢–ê–ü 2: –ú–Ø–ß –†–Ø–î–û–ú - –ù–ê–ß–ò–ù–ê–ï–ú –ö–û–ù–¢–†–û–õ–¨
        if (ball.distance <= 1.0 && ball.distance > 0.5) {
            console.log("üîÑ GETTING BALL UNDER CONTROL...");
            this.lastAction = "get_control";
            this.dribbleState.phase = "control";

            // –û—á–µ–Ω—å –º—è–≥–∫–æ–µ –∫–∞—Å–∞–Ω–∏–µ, —á—Ç–æ–±—ã –ø–æ–¥—Ç—è–Ω—É—Ç—å –º—è—á
            if (goal) {
                // –ï—Å–ª–∏ –≤–∏–¥–∏–º –≤–æ—Ä–æ—Ç–∞, –ø–æ–¥—Ç—è–≥–∏–≤–∞–µ–º –º—è—á –≤ –∏—Ö —Å—Ç–æ—Ä–æ–Ω—É
                let kickAngle = goal.direction * 0.5;
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π socketSend
                this.socketSend("kick", "5", kickAngle);
            } else {
                // –ò–Ω–∞—á–µ –ø—Ä–æ—Å—Ç–æ –ø–æ–¥—Ç—è–≥–∏–≤–∞–µ–º –∫ —Å–µ–±–µ
                this.socketSend("kick", "3", "0");
            }
            return;
        }

        // –≠–¢–ê–ü 3: –ú–Ø–ß –ü–û–î –ö–û–ù–¢–†–û–õ–ï–ú (–æ—á–µ–Ω—å –±–ª–∏–∑–∫–æ)
        if (ball.distance <= 0.5) {
            this.dribbleState.phase = "dribble";

            if (!goal) {
                // –í–æ—Ä–æ—Ç –Ω–µ –≤–∏–¥–Ω–æ - –ø–æ–≤–æ—Ä–∞—á–∏–≤–∞–µ–º—Å—è —Å –º—è—á–æ–º, —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ –∏—Ö
                console.log("üëÄ Goal not visible, turning with ball to find goal");
                this.lastAction = "turn_with_ball";

                // –ú—è–≥–∫–∏–π —É–¥–∞—Ä –¥–ª—è –ø–æ–≤–æ—Ä–æ—Ç–∞ –º—è—á–∞
                this.socketSend("kick", "8", "45");
                return;
            }

            // –í–æ—Ä–æ—Ç–∞ –≤–∏–¥–Ω—ã - –í–ï–î–ï–ú –ú–Ø–ß –ö –í–û–†–û–¢–ê–ú
            console.log(`üéØ DRIBBLING toward goal at angle ${goal.direction.toFixed(1)}`);
            this.lastAction = "dribbling";

            // –£–≥–æ–ª –¥–æ –≤–æ—Ä–æ—Ç
            const goalAngle = goal.direction;

            // –ï—Å–ª–∏ —É–≥–æ–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π - —Å–Ω–∞—á–∞–ª–∞ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
            if (Math.abs(goalAngle) > 20) {
                console.log(`‚Ü™Ô∏è Correcting direction (angle too big: ${goalAngle.toFixed(1)})`);
                // –ú—è–≥–∫–∏–π —É–¥–∞—Ä —Å –ø–æ–≤–æ—Ä–æ—Ç–æ–º –≤ —Å—Ç–æ—Ä–æ–Ω—É –≤–æ—Ä–æ—Ç
                let kickAngle = goalAngle * 0.6;
                this.socketSend("kick", "10", kickAngle);
                return;
            }

            // –û–°–ù–û–í–ù–û–ï –í–ï–î–ï–ù–ò–ï: —Å–µ—Ä–∏—è –∫–æ—Ä–æ—Ç–∫–∏—Ö –∫–∞—Å–∞–Ω–∏–π
            this.dribbleState.consecutiveKicks++;

            // –°–∏–ª–∞ —É–¥–∞—Ä–∞ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –¥–æ –≤–æ—Ä–æ—Ç
            let kickPower;

            if (goal.distance < 20) {
                // –ë–ª–∏–∑–∫–æ –∫ –≤–æ—Ä–æ—Ç–∞–º - —Å–∫–æ—Ä–æ –±—É–¥–µ–º –±–∏—Ç—å
                console.log(`‚ö° CLOSE TO GOAL! Distance: ${goal.distance.toFixed(1)}`);
                kickPower = 15;
            } else {
                // –î–∞–ª–µ–∫–æ –æ—Ç –≤–æ—Ä–æ—Ç - —Å–ø–æ–∫–æ–π–Ω–æ–µ –≤–µ–¥–µ–Ω–∏–µ
                kickPower = 12;
            }

            // –í—ã–ø–æ–ª–Ω—è–µ–º –∫–æ—Ä–æ—Ç–∫–æ–µ –∫–∞—Å–∞–Ω–∏–µ –º—è—á–∞ –≤–ø–µ—Ä–µ–¥
            console.log(`ü¶∂ Kick #${this.dribbleState.consecutiveKicks}: power=${kickPower}, angle=0 `);
            this.socketSend("kick", kickPower.toString(), "0");

            // –í–∞–∂–Ω–æ: –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –∫–∞—Å–∞–Ω–∏—è –±–µ–∂–∏–º –∑–∞ –º—è—á–æ–º
            // –ù–æ –Ω–µ —Å—Ä–∞–∑—É, —á—Ç–æ–±—ã –º—è—á —É—Å–ø–µ–ª –æ—Ç–∫–∞—Ç–∏—Ç—å—Å—è
            setTimeout(() => {
                if (this.dribbleState.ballUnderControl) {
                    this.socketSend("dash", 40);
                }
            }, 50);

            // –≠–¢–ê–ü 4: –£–î–ê–† –ü–û –í–û–†–û–¢–ê–ú
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–æ—Ä–∞ –ª–∏ –±–∏—Ç—å
            const shouldShoot =
                (goal.distance < 25 && Math.abs(goal.direction) < 10) || // –ë–ª–∏–∑–∫–æ –∫ –≤–æ—Ä–æ—Ç–∞–º –∏ –ø—Ä—è–º–æ
                (goal.distance < 18) || // –û—á–µ–Ω—å –±–ª–∏–∑–∫–æ
                (this.dribbleState.consecutiveKicks > 8 && goal.distance < 30); // –î–æ–ª–≥–æ –≤–µ–ª–∏

            if (shouldShoot) {
                console.log(`üí•üí•üí• SHOOTING! Distance to goal: ${goal.distance.toFixed(1)}`);
                this.lastAction = "shoot";

                // –°–∏–ª—å–Ω—ã–π —É–¥–∞—Ä –≤ —Å—Ç–æ—Ä–æ–Ω—É –≤–æ—Ä–æ—Ç
                let shootAngle = 0;
                if (Math.abs(goal.direction) < 15) {
                    shootAngle = 0;
                } else {
                    shootAngle = goal.direction * 0.3;
                }

                this.socketSend("kick", "100", shootAngle.toString());

                // –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –¥–µ–π—Å—Ç–≤–∏—é –ø–æ—Å–ª–µ —É–¥–∞—Ä–∞
                this.dribbleState.consecutiveKicks = 0;
                this.dribbleState.phase = "approach";

                // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –ø—É–Ω–∫—Ç—É –º–∞—Ä—à—Ä—É—Ç–∞
                setTimeout(() => {
                    this.currentRouteIndex++;
                    if (this.currentRouteIndex >= this.route.length) {
                        this.currentRouteIndex = 0;
                    }
                }, 500);
            }
        }
    }

    moveTo(x, y) {
        if (!this.initialized) {
            setTimeout(() => this.moveTo(x, y), 500);
            return;
        }
        // move —Ç–æ–∂–µ —Ç—Ä–µ–±—É–µ—Ç –¥–≤–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞
        this.socketSend("move", x, y);
        console.log(`Moving to start position (${x}, ${y})`);
    }
}

module.exports = Agent;